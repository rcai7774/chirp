<!DOCTYPE html>
<html>
    <head>
        <title>Chirp</title>
        <script src = "he.js"></script>
					<script>
					
              function message(){
                 let message = document.getElementById("message").value;
                 let token = localStorage.getItem("token");
								 message = he.encode(message);
                 let info = {
                        message: message
                      }
                      fetch('/api/post-message', {
                        method: 'post',
                        headers: {
                        'Authorization': 'bearer ' + token,
                        'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/json'
                         },
                       body: JSON.stringify(info)
                      }).then(res=>res.json()).then(res => {
                        console.log(res); document.getElementById("result").innerHTML = "Message Sent."; document.getElementById("message").value = "";
              })
              }

							setInterval(function clearRes(){
								document.getElementById("result").innerHTML = "";
							}, 10000)

            setInterval(function readMessage(){
            		let feed = document.getElementById('message_feed');
            		let token = localStorage.getItem("token");
            		fetch('api/get-messages', {
            			method: 'get',
            			headers: {
            				'Authorization': 'bearer ' + token,
            				'Accept': 'application/json, text/plain, */*',
            				'Content-Type': 'application/json'
            			}
            		}).then(res=>res.json()).then(res => {
            			console.log("lengthofres: " + res.length);
            			displayMessages(res, feed);
            		})
            	}, 
							1000);

            	function displayMessages(res, feed){
            		let tblHtml = `
            		<li style = "text-align: right">`;
            		for(const k of res){
            			tblHtml += createRow(k);
            		}
            		tblHtml += `</li>`;
            		feed.innerHTML = tblHtml;
            	}

            	function createRow(k){
            		return `<li>
            		<b>${k.author}</b>: ${k.message}, Posted at ${k.posted_at}  <img src = "thumb-up.png" width = "20px" height = "20px" onhover = "" onclick = "likePost(${k.id})"/> ${k.post_likes}
            		</li>
            		<br>`
            	}

							  function likePost(id){
                 let token = localStorage.getItem("token"); 
                 let info = {
									 			'id': id
                      }
                      fetch('/api/like-message', {
                        method: 'post',
                        headers: {
                        'Authorization': 'bearer ' + token,
                        'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/json'
                         },
                       body: JSON.stringify(info)
                      }).then(res=>res.json()).then(res => {
                        console.log(res); 
												console.log('liked');
												document.getElementById("result").innerHTML = "Message Liked."; 
              })
              }


							function logMeOut(){
								localStorage.setItem("token", "")
								window.open("https://chirp.rcai7774.repl.co" , "_parent")
							}
        </script>
    </head>

    <body style="background-color: #c4e2ed; font-family: Courier New;">
        <center><h1>Chirp</h1></center>
        <br />
        <left>
					<img src = "thumb-up.png" width = "20px" height = "20px"/>
					<div>(‚ïØ¬∞‚ñ°¬∞Ôºâ‚ïØÔ∏µ ‚îª‚îÅ‚îª</div>
					<br>
					<div>üéß</div>
					<br>
					<div>¬Ø\_(„ÉÑ)_/¬Ø</div>
					<br>
            <textarea align = "left" id="message" rows="10" cols="50" style="background-color: #c4e2ed; font-family: Courier New;">Send your Chirp here!</textarea>
						<br>
						 <input style="background-color: #c4e2ed;" type="button" name="Send Chirp" value="Send" onclick="message()" />
						<br>
						<div cols = "50" id="message_feed" align="right">See messages from others here!</div>
            <br />
            <div id="result"></div>
            <br />
						<button style = "background-color: #c4e2ed;" type = "button" onclick = "logMeOut()">Log Out</button>
        </left>
				<br>
<div width = "10px">Icons made by <a href="https://www.flaticon.com/authors/pixel-perfect" title="Pixel perfect">Pixel perfect</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>

    </body>
</html>
